---
title: "Human Lung Cell Atlas - Patient 1, SS2 Annotation"
output:
  html_document: default
  html_notebook: default
---

# Print packages and load the data

```{r, fig.height=10, fig.width=10}
installed.packages()[,'Version']
```

```{r, fig.height=10, fig.width=10}
# Specify the tissue of interest, run the boilerplate code which sets up the functions and environment, load the tissue object.
tissue_of_interest = "hlca_facs_patient_1"
library(here)
source(here("boilerplate.R"))
tiss <- load_tissue_facs(tissue_of_interest)
```

# Perform the first round of clustering to seperate cells by tissue compartment

```{r, fig.height=10, fig.width=10}
# Plot heatmaps with the most differentially loaded genes along the first 18 pinciple components (PCs)
# The first few PCs will represent compartment-level axes of variation at this level
PCHeatmap(object = tiss, pc.use = 1:9, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = tiss, pc.use = 9:18, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
# Perform low-resolution louvain clustering on all cells from the patient with the first 20 PCs
# Set number of principal components.
n.pcs = 20
# Set resolution
res.used <- 2

tiss <- FindClusters(object = tiss, reduction.type = "pca", dims.use = 1:n.pcs,
    resolution = res.used, print.output = 0, save.SNN = TRUE)
```

```{r, fig.height=10, fig.width=10}
# Calculate and plot 2D embedding of cells from first 20 PCs
tiss <- RunTSNE(object = tiss, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)
TSNEPlot(object = tiss, do.label = T)
```

```{r, fig.height=10, fig.width=10}
# Plot metadata parameters to look for technical artifacts
TSNEPlot(object = tiss, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "region")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "sample")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "gating")
FeaturePlot(object = tiss, 'nGene', cols.use = my.cols)
FeaturePlot(object = tiss, 'nReads', cols.use = my.cols)
```

# Discard cells from the tumor and redo low-resolution clustering

```{r, fig.height=10, fig.width=10}
ntiss = SubsetData(tiss, cells.use = rownames(tiss@meta.data[which(tiss@meta.data[,'region'] == 'normal'),]))
```

```{r, fig.height=10, fig.width=10}
# Rescale data, reselect HVGs, and rerun PCA on the subsetted cells
ntiss <- ntiss %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss, pc.use = 9:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
n.pcs = 20
res.use = 2
ntiss <- ntiss %>% FindClusters(reduction.type = "pca", dims.use = 1:n.pcs,
    resolution = res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:n.pcs, seed.use = 10, perplexity=30, force.recalc = TRUE)

TSNEPlot(object = ntiss, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss, 'nReads', cols.use = my.cols)
```

```{r, fig.width=10, fig.height=10}
# Plot compartment level genes to segregate them
genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2'))
FeaturePlot(ntiss, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols)
```

# Subclustering stromal cells

```{r, fig.height=10, fig.width=10}
# Pull CellIDs that correspond to stromal clusters AND lack expression of other compartment markers (common doublet signature)
cells.to.use = intersect(WhichCells(ntiss, c(8,13,15,19,22)), intersect(intersect(names(which(ntiss@data['EPCAM',] < 0.1)), names(which(ntiss@data['PECAM1',] < 0.1))), names(which(ntiss@data['PTPRC',] < 0.1))))
ntiss.stromal = SubsetData(ntiss, cells.use = cells.to.use)
```

```{r, fig.height=10, fig.width=10}
ntiss.stromal <- ntiss.stromal %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
# The PCs here should reflect axes of variation that exist between cell types and states.
# Pay attention to avoid including PCs that represent common technical artifacts (e.g. immediate early genes)
# The number of relevant PCs depends on the amount of cellular diversity, cutoffs are qualitatively chosen
PCHeatmap(object = ntiss.stromal, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.stromal, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 8
normal.res.use = 0.5
ntiss.stromal <- ntiss.stromal %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.stromal, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "label")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.stromal, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.stromal, 'nReads', cols.use = my.cols)
```

```{r, fig.height=50, fig.width=10}
# Plot canonical marker genes for cell type annotation
genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2', 'SERPINF1', 'ACTA2' , 'CNN1', 'CSPG4', 'PDGFRA', 'PDGFRB', 'TRPC6', 'DES', 'SCARA5', 'LGR5', 'LGR6', 'KCNK3', 'FGF18', 'ASPN', 'PLIN2', 'APOE')
FeaturePlot(ntiss.stromal, genes_to_check, pt.size = 2 nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
# Calculate marker genes for each cluster using MAST
ntiss.stromal.markers <- FindAllMarkers(ntiss.stromal, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=60, fig.width=10}
# Plot unbiased marker genes for each cluster to assess quality of divisions
genes_to_check <- ntiss.stromal.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.stromal.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.stromal, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# All stromal cells are CD45- CD31- EPCAM-
# COX4I2+ HIGD1B+ GJA4+ CNN- -> Pericyte
# ACTA2+ TAGLN+ CNN1+ MYH11+ KCNA5+ LGR6+ DES+ -> Airway Smooth Muscle
# ACTA2+ TAGLN+ CNN1+ MYH11+ GJA4+ KCNK3+  -> Vascular Smooth Muscle
# SLC38A5+ GDF10+ GPC3+ ITGA8+ -> Alveolar Fibroblast
# PLIN2+ APOE+ -> Lipofibroblast

# Stash current cluster IDs
ntiss.stromal <- StashIdent(object = ntiss.stromal, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.stromal@ident)))
free_annotation <- c("Airway Smooth Muscle",
                     "Vascular Smooth Muscle",
                     "Alveolar Fibroblast",
                     "Airway Smooth Muscle",
                     NA,
                     "Pericyte")

ntiss.stromal@meta.data[,'free_annotation'] <- NA
ntiss.stromal@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.stromal@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering stromal cells (Round 2)

```{r, fig.height=10, fig.width=10}
ntiss.stromal.r2 = SubsetData(ntiss.stromal, ident.use = 4)
```

```{r, fig.height=10, fig.width=10}
ntiss.stromal.r2 <- ntiss.stromal.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.stromal.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.stromal.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 3
normal.res.use = 2
ntiss.stromal.r2 <- ntiss.stromal.r2 %>% FindClusters(reduction.type = "pca", dims.use = 2:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=20)

TSNEPlot(object = ntiss.stromal.r2, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.stromal.r2, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.stromal.r2, 'nReads', cols.use = my.cols)
```

```{r, fig.height=40, fig.width=10}

genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2', 'SERPINF1', 'ACTA2', 'CSPG4', 'PDGFRA', 'PDGFRB', 'TRPC6', 'DES', 'SCARA5', 'LGR5', 'LGR6', 'FGF18', 'ASPN', 'PLIN2', 'APOE')

FeaturePlot(ntiss.stromal.r2, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.stromal.r2.markers <- FindAllMarkers(ntiss.stromal.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=200, fig.width=10}
genes_to_check <- ntiss.stromal.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.stromal.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.stromal.r2, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# SERPINF1+ PI16+ FBLN1+ SCARA5+ SLC38A5- -> Adventitial Fibroblast
# PLIN2+ APOE+ -> Lipofibroblast

# Stash current cluster IDs
ntiss.stromal.r2 <- StashIdent(object = ntiss.stromal.r2, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.stromal.r2@ident)))
free_annotation <- c("Lipofibroblast",
                     "Adventitial Fibroblast",
                     "Adventitial Fibroblast",
                     "Adventitial Fibroblast",
                     "Adventitial Fibroblast",
                     "Adventitial Fibroblast")

ntiss.stromal.r2@meta.data[,'free_annotation'] <- NA
ntiss.stromal.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.stromal.r2@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering epithelial cells

```{r, fig.height=10, fig.width=10}
# ROBO4, PPP1R14A, and PECAM1 are in endothelial cells. This signature represents a common epithelial/endothelial cell doublet
cells.to.use = WhichCells(ntiss, c(0,4,6,9,10,18,21,25))
cells.to.use = intersect(intersect(cells.to.use,intersect(names(which(ntiss@data['ROBO4',] < 0.1)),names(which(ntiss@data['PPP1R14A',] < 0.1)))),names(which(ntiss@data['PECAM1',] < 0.1)))

ntiss.epi = SubsetData(ntiss, cells.use = cells.to.use)
```

```{r, fig.height=10, fig.width=10}
ntiss.epi <- ntiss.epi %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.epi, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.epi, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 18
normal.res.use = 3
ntiss.epi <- ntiss.epi %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.epi, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.epi, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.epi, 'nReads', cols.use = my.cols)
```

```{r, fig.height=60, fig.width=10}
genes_to_check = c('PTPRC', 'EPCAM', 'PECAM1', 'COL1A1', 'SFTPC', 'WIF1', 'ETV5', 'ACTA2', 'PDPN', 'CLIC5', 'FOXJ1', 'TUBB4B', 'SCGB1A1', 'SCGB3A2', 'MUC5B', 'MUC5AC', 'CHGA', 'CALCA', 'CFTR', 'NGFR', 'TP63', 'KRT5', 'KRT14', 'S100A2', 'MKI67', 'FOS')
FeaturePlot(ntiss.epi, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.epi.markers <- FindAllMarkers(ntiss.epi, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=160, fig.width=10}
genes_to_check <- ntiss.epi.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.epi.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.epi, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# Relying on canonical markers to call populations (a few representative markers are shown). All epithelial cells are CD45- CD31-
# SFP*+ ETV5+ MUC1+ -> Alveolar Epithelial Type 2
# Above, but HHIP- WIF- TCFPL2+ -> Signaling Alveolar Epithelial Type 2
# HOPX+ PDPN+ CLIC5+ SPC*- -> Alveolar Epithelial Type 1
# SCGB1A1+ SCGB3A2+ SP*- FOXJ1- -> Club
# MUC5AC+ MUC5B+ KCNQ2+ -> Goblet
# FOXJ1+ TUBB4+ -> Ciliated
# KRT5+ KRT14+ -> Basal
# CHGA+ CALCA+ GRP+ -> Neuroendocrine

# Stash current cluster IDs
ntiss.epi <- StashIdent(object = ntiss.epi, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.epi@ident)))
free_annotation <- c("Alveolar Epithelial Type 2",
                     "Ciliated",
                     "Club",
                     "Club",
                     "Signaling Alveolar Epithelial Type 2",
                     "Club",
                     "Alveolar Epithelial Type 1",
                     "Club",
                     "Club",
                     "Ciliated",
                     "Club",
                     "Signaling Alveolar Epithelial Type 2",
                     "Club",
                     "Neuroendocrine",
                     "Basal",
                     "Goblet")

ntiss.epi@meta.data[,'free_annotation'] <- NA
ntiss.epi@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.epi@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss.epi, group.by = 'free_annotation', do.label = TRUE)
```

# Subclustering endothelial cells

```{r, fig.height=10, fig.width=10}
# EPCAM and LUM are specific to endothelial/epthelial and endothelial/stromal cell doublets in epithelial cell clusters, respectively
cells.to.use = WhichCells(ntiss, c(5,7,11,23))
cells.to.use = intersect(intersect(cells.to.use, names(which(ntiss@data['EPCAM',] < 0.1))), names(which(ntiss@data['LUM',] < 0.1)))

ntiss.endo = SubsetData(ntiss, cells.use = cells.to.use)
```

```{r, fig.height=10, fig.width=10}
ntiss.endo <- ntiss.endo %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.endo, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.endo, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 13
normal.res.use = 1
ntiss.endo <- ntiss.endo %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.endo, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.endo, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.endo, 'nReads', cols.use = my.cols)
```

```{r, fig.height=60, fig.width=10}
genes_to_check <- c('EPCAM', 'PECAM1', 'COL1A2', 'PTPRC', 'CXCL12', 'DKK2', 'GJA5', 'SLC6A4', 'GPIHBP1', 'EDNRB', 'MYC', 'SPRY1', 'ACKR1', 'SOSTDC1', 'FOS', 'PDPN', 'PROX1', 'MMRN2', 'IL7R', 'PTGDS', 'EMCN', 'TOP2A')

FeaturePlot(ntiss.endo, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.endo.markers <- FindAllMarkers(ntiss.endo, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=60, fig.width=10}
genes_to_check <- ntiss.endo.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.endo.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.endo, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
#All endothelial cells are CD45- EpCAM- COl1A1-
#IL7R+ SLC6A4+ FCN3+ C7- CPE- ACKR1- -> Capillary
#APLN+ EDNRB+ HPGD+ IL1RL1+  -> Capillary Aerocyte
#F2R+ DKK2+ SERPINE2+ -> Artery

# Stash current cluster IDs
ntiss.endo <- StashIdent(object = ntiss.endo, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.endo@ident)))
free_annotation <- c("Capillary",
                     "Capillary",
                     NA,
                     "Capillary Aerocyte",
                     "Capillary Aerocyte",
                     "Artery")

ntiss.endo@meta.data[,'free_annotation'] <- NA
ntiss.endo@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.endo@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering endothelial cells (Round 2)

```{r, fig.height=10, fig.width=10}
ntiss.endo.r2 = SubsetData(ntiss.endo, ident.use = c(2))
```

```{r, fig.height=10, fig.width=10}
ntiss.endo.r2 <- ntiss.endo.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.endo.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.endo.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 5
normal.res.use = 1
ntiss.endo.r2 <- ntiss.endo.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.endo.r2, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.endo.r2, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.endo.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.endo.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.endo.r2, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.endo.r2, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.endo.r2, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.endo.r2, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.endo.r2, 'nReads', cols.use = my.cols)
```

```{r, fig.height=40, fig.width=10}
genes_to_check <- c('EPCAM', 'PECAM1', 'COL1A2', 'PTPRC', 'CXCL12', 'DKK2', 'GJA5', 'SLC6A4', 'GPIHBP1', 'EDNRB', 'MYC', 'SPRY1', 'ACKR1', 'SOSTDC1', 'FOS', 'PDPN', 'PROX1', 'MMRN2', 'IL7R', 'PTGDS', 'EMCN', 'TOP2A')

FeaturePlot(ntiss.endo.r2, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.endo.r2.markers <- FindAllMarkers(ntiss.endo.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=30, fig.width=10}
genes_to_check <- ntiss.endo.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.endo.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.endo.r2, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# TFF3+ PDPN+ CCL21+ IGF1+ -> Lymphatics
# MYC+ SPRY1+ -> Bronchial Vessel 1

# Stash current cluster IDs
ntiss.endo.r2 <- StashIdent(object = ntiss.endo.r2, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.endo.r2@ident)))
free_annotation <- c("Bronchial Vessel 1",
                     "Bronchial Vessel 1",
                     "Lymphatics")

ntiss.endo.r2@meta.data[,'free_annotation'] <- NA
ntiss.endo.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.endo.r2@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering immune cells

```{r, fig.height=10, fig.width=10}
ntiss.immune = SubsetData(ntiss, ident.use = c(1,2,3,12,14,16,17,20))
```

```{r, fig.height=10, fig.width=10}
ntiss.immune <- ntiss.immune %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune, pc.use = 9:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 20
normal.res.use = 1.5
ntiss.immune <- ntiss.immune %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.immune, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.immune, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.immune, 'nReads', cols.use = my.cols)
```

```{r, fig.height=55, fig.width=10}
genes_to_check = c('PTPRC', 'CLDN5', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'KLRB1', 'AREG', 'CHST2', 'CD79A', 'CD19', 'MS4A1', 'CD24', 'CD68', 'FCGR3A', 'CD14', 'MARCO', 'MSR1', 'MRC1', 'MKI67', 'FCER1G', 'CPA3', 'RGS13')

FeaturePlot(ntiss.immune, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.markers <- FindAllMarkers(ntiss.immune, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=80, fig.width=10}
genes_to_check <- ntiss.immune.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# Calling immune cells based on canonical markers and bulk RNAseq data. All immune cells are EPCAM- COL1A2-, some are CD31+
# FCER1G+ TYROBP+ GZMB+ CHST2+ HOPX+ CD3E- -> Natural Killer
# S100A8+ S100A9+ S100A12+ -> Neutrophil

# Stash current cluster IDs
ntiss.immune <- StashIdent(object = ntiss.immune, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune@ident)))
free_annotation <- c(NA,
                     "Natural Killer",
                     NA,
                     "Natural Killer",
                     NA,
                     NA,
                     NA,
                     "Neutrophil",
                     NA)

ntiss.immune@meta.data[,'free_annotation'] <- NA
ntiss.immune@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering immune cells (Round 2)

```{r, fig.height=10, fig.width=10}
ntiss.immune.r2 = SubsetData(ntiss.immune, ident.use = c(0,2,5,8))
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r2 <- ntiss.immune.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune.r2, pc.use = 9:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 10
normal.res.use = 1
ntiss.immune.r2 <- ntiss.immune.r2 %>% FindClusters(reduction.type = "pca", dims.use = 2:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T) %>%
    RunTSNE(dims.use = 2:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.immune.r2, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.immune.r2, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.immune.r2, 'nReads', cols.use = my.cols)
```

```{r, fig.height=40, fig.width=10}

genes_to_check = c('CD3E', 'CD4', 'CD8A', 'KLRB1', 'MKI67', 'STMN1', 'TOP2A', 'GZMK', 'IL7R', 'KLRD1', 'AREG', 'LDHB', 'CCR7', 'LEF1', 'GZMH', 'DUSP2')

FeaturePlot(ntiss.immune.r2, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r2.markers <- FindAllMarkers(ntiss.immune.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=70, fig.width=10}
genes_to_check <- ntiss.immune.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune.r2, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# CD3E+ CD4+ LTB+ COTL1+ LDHB+ CCR7- LEF1- -> CD4+ Memory/Effector T
# CD3E+ CD4+ LTB+ LDHB+ CCR7+ LEF1+ COTL1- -> CD4+ Naive T

# Stash current cluster IDs
ntiss.immune.r2 <- StashIdent(object = ntiss.immune.r2, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune.r2@ident)))
free_annotation <- c(NA,
                     "CD4+ Memory/Effector T",
                     "CD4+ Naive T",
                     NA,
                     NA,
                     NA)

ntiss.immune.r2@meta.data[,'free_annotation'] <- NA
ntiss.immune.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune.r2@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering immune cells (Round 3)

```{r, fig.height=10, fig.width=10}
ntiss.immune.r3 = SubsetData(ntiss.immune.r2, ident.use = c(0,3,4,5))
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r3 <- ntiss.immune.r3 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune.r3, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune.r3, pc.use = 9:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 5
normal.res.use = 1
ntiss.immune.r3 <- ntiss.immune.r3 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.immune.r3, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.immune.r3, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.immune.r3, 'nReads', cols.use = my.cols)
```

```{r, fig.height=25, fig.width=10}

genes_to_check = c('CD3E', 'KLRB1', 'MKI67', 'STMN1', 'TOP2A', 'GZMK', 'IL7R', 'GZMB', 'GZMH')

FeaturePlot(ntiss.immune.r3, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r3.markers <- FindAllMarkers(ntiss.immune.r3, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=50, fig.width=10}
genes_to_check <- ntiss.immune.r3.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.r3.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune.r3, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# CD3E+ CD8+ GZMH+ GZMB+ LTB- IL7R- GZMK- DUSP2- -> CD8+ Naive T
# CD3E+ CD8+ GZMK+ KLRB1+ IL7R+ DUSP2+ GZMH- GZMB- -> CD8+ Memory/Effector T

# Stash current cluster IDs
ntiss.immune.r3 <- StashIdent(object = ntiss.immune.r3, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune.r3@ident)))
free_annotation <- c("CD8+ Naive T",
                     "CD8+ Naive T",
                     "CD8+ Naive T",
                     "CD8+ Naive T",
                     "CD8+ Memory/Effector T")

ntiss.immune.r3@meta.data[,'free_annotation'] <- NA
ntiss.immune.r3@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune.r3@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering immune cells (Round 4)

```{r, fig.height=10, fig.width=10}
ntiss.immune.r4 = SubsetData(ntiss.immune, ident.use = c(4))
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r4 <- ntiss.immune.r4 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, x.low.cutoff = 2) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune.r4, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune.r4, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 7
normal.res.use = 0.5
# The NN graph required more stringent pruning to resemble a "large network" for louvain when the number and diversity of cells was low
ntiss.immune.r4 <- ntiss.immune.r4 %>% FindClusters(reduction.type = "pca", dims.use = 1:7,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/2) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.immune.r4, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.immune.r4, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune.r4, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune.r4, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune.r4, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune.r4, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.immune.r4, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.immune.r4, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.immune.r4, 'nReads', cols.use = my.cols)
```

```{r, fig.height=50, fig.width=10}
genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2', 'CD79A', 'S100A8', 'MARCO', 'CD68', 'MRC1', 'MSR1', 'FCGR3A', 'CD14', 'CLEC10A', 'GPR183', 'BASP1', 'F13A1', 'SEPP1', 'RNASE1', 'CX3CR1')

FeaturePlot(ntiss.immune.r4, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r4.markers <- FindAllMarkers(ntiss.immune.r4, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=120, fig.width=10}
genes_to_check <- ntiss.immune.r4.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.r4.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune.r4, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# LGALS2+ CD14+ NRG1+ S100A8+ S100A9+ S100A12+ -> Classical Monocyte
# CDKN1C+ CD79B+ LYPD2+ CHST2+ IFITM2+ HES4+ CD16+ -> Nonclassical Monocyte
# CD14+ CD16+ GPR183+ -> Dendritic (not enough cells to categorize to types seen in 10x)

# Stash current cluster IDs
ntiss.immune.r4 <- StashIdent(object = ntiss.immune.r4, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune.r4@ident)))
free_annotation <- c("Classical Monocyte",
                     "Nonclassical Monocyte",
                     "Classical Monocyte",
                     "Classical Monocyte",
                     "Dendritic",
                     "Classical Monocyte",
                     "Dendritic",
                     "Dendritic")

ntiss.immune.r4@meta.data[,'free_annotation'] <- NA
ntiss.immune.r4@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune.r4@ident, from = cluster.ids, to = free_annotation))
```

# Subclustering immune cells (Round 5)

```{r, fig.height=10, fig.width=10}
ntiss.immune.r5 = SubsetData(ntiss.immune, ident.use = c(6))
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r5 <- ntiss.immune.r5 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, x.low.cutoff = 2) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune.r5, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune.r5, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
normal.n.pcs = 2
normal.res.use = 1.5
ntiss.immune.r5 <- ntiss.immune.r5 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.immune.r5, do.label = T, pt.size = 2, label.size = 10)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.immune.r5, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune.r5, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune.r5, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune.r5, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune.r5, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.immune.r5, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.immune.r5, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.immune.r5, 'nReads', cols.use = my.cols)
```

```{r, fig.height=20, fig.width=10}

genes_to_check = toupper(c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2', 'Cd79a', 'CD27', 'CD19', 'CD24'))

FeaturePlot(ntiss.immune.r5, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r5.markers <- FindAllMarkers(ntiss.immune.r5, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')
```

```{r, fig.height=100, fig.width=10}
genes_to_check <- ntiss.immune.r5.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.r5.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune.r5, genes_to_check$gene, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# CD79A+ CD24+ MS4A1+ CD19+ -> B
# SCAMP5+ TPM2+ CST3+ RASD1+ -> Plasmacytoid Dendritic

# Stash current cluster IDs
ntiss.immune.r5 <- StashIdent(object = ntiss.immune.r5, save.name = "cluster.ids")

# Enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune.r5@ident)))
free_annotation <- c("B",
                     "B",
                     "B",
                     "B",
                     "Plasmacytoid Dendritic")

ntiss.immune.r5@meta.data[,'free_annotation'] <- NA
ntiss.immune.r5@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune.r5@ident, from = cluster.ids, to = free_annotation))
```

# Combine all subclustering annotaitons

```{r, fig.height=10, fig.width=10}
ntiss@meta.data[,'free_annotation'] <- NULL

# Mast/Basophil were so distinct we annotate them from the low-resolution clustering
ntiss@meta.data[WhichCells(ntiss, ident = 26),'free_annotation'] <- 'Mast/Basophil 1'

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.epi@meta.data)),'free_annotation'] <- ntiss.epi@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.epi@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.endo@meta.data)),'free_annotation'] <- ntiss.endo@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.endo@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.endo.r2@meta.data)),'free_annotation'] <- ntiss.endo.r2@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.endo.r2@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal@meta.data)),'free_annotation'] <- ntiss.stromal@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal.r2@meta.data)),'free_annotation'] <- ntiss.stromal.r2@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal.r2@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune@meta.data)),'free_annotation'] <- ntiss.immune@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r2@meta.data)),'free_annotation'] <- ntiss.immune.r2@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r2@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r3@meta.data)),'free_annotation'] <- ntiss.immune.r3@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r3@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r4@meta.data)),'free_annotation'] <- ntiss.immune.r4@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r4@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r5@meta.data)),'free_annotation'] <- ntiss.immune.r5@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r5@meta.data)),'free_annotation']
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(ntiss, do.label = T, group.by = 'free_annotation', no.legend = TRUE)
```

# Removing suspected doublets and recalculate 2D embedding

```{r, fig.height=10, fig.width=10}
ntiss.anno = SubsetData(ntiss, cells.use = rownames(ntiss@meta.data[which(!is.na(ntiss@meta.data[,'free_annotation'])),]))
```

```{r, fig.height=10, fig.width=10}
ntiss.anno <- ntiss.anno %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.anno, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.anno, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.anno, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
n.pcs = 25
res.use = 2
ntiss.anno <- ntiss.anno %>%
    RunTSNE(dims.use = 1:n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.anno, do.label = T, pt.size = 2, label.size = 4, group.by = 'free_annotation', no.legend = TRUE)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "sample")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "gating")
FeaturePlot(object = ntiss.anno, 'nGene', cols.use = my.cols)
FeaturePlot(object = ntiss.anno, 'nReads', cols.use = my.cols)
```

```{r, fig.height=10, fig.width=10}

genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2')

FeaturePlot(ntiss.anno, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols)
```

```{r, fig.height=10, fig.width=10}
#Reassign clusters based on cell type
clusters = 1:length(table(ntiss.anno@meta.data[,'free_annotation']))
names(clusters) = names(sort(table(ntiss.anno@meta.data[,'free_annotation']), decreasing = T))
ntiss.anno@meta.data[,'cluster_ids'] <- clusters[ntiss.anno@meta.data[,'free_annotation']]
clusters <- clusters[ntiss.anno@meta.data[,'free_annotation']]
names(clusters) <- rownames(ntiss.anno@meta.data)
ntiss.anno@ident <- as.factor(clusters)
```

```{r, fig.height=10, fig.width=10}
TSNEPlot(object = ntiss.anno, do.label = T, pt.size = 2, label.size = 4, no.legend = TRUE)
```

# Save the Robject for later
When you save the annotated tissue, please give it a name.

```{r, fig.height=10, fig.width=10}
ntiss.P1.anno.gencode <- ntiss.anno
filename = here('seurat', paste0("facs_normal_lung_blood_seurat_ntiss.P1.anno.gencode.20191002.RC4.Robj"))
print(filename)
save(ntiss.P1.anno.gencode, file=filename)
```

```{r}
# To reload a saved object
# load(file=filename)
```



