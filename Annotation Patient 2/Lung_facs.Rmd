---
title: "Human Lung Cell Atlas - Patient 2, SS2"
output:
  html_document: default
  html_notebook: default
---

# All Package versions used

```{r, fig.height=10, fig.width=10}
installed.packages()[,'Version']

```

# Specify the tissue of interest, run the boilerplate code which sets up the functions and environment, load the tissue object.

```{r, fig.height=10, fig.width=10}
tissue_of_interest = "hlca_facs_patient_2"
library(here)
source(here("boilerplate.R"))
tiss <- load_tissue_facs(tissue_of_interest)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = tiss, pc.use = 1:9, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = tiss, pc.use = 9:18, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

```

```{r, fig.height=10, fig.width=10}
PCElbowPlot(object = tiss)
```

```{r, fig.height=10, fig.width=10}
# Set number of principal components. 
n.pcs = 20
# Set resolution 
res.used <- 2

tiss <- FindClusters(object = tiss, reduction.type = "pca", dims.use = 1:n.pcs, 
    resolution = res.used, print.output = 0, save.SNN = TRUE)
```

```{r, fig.height=10, fig.width=10}
tiss <- RunTSNE(object = tiss, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)
```

```{r, fig.height=10, fig.width=10}
# note that you can set do.label=T to help label individual clusters
TSNEPlot(object = tiss, do.label = T, label.size = 10, pt.size = 2)
```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = tiss, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "region")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "sample")
```

# Subclustering normal cells

```{r, fig.height=10, fig.width=10}
ntiss = SubsetData(tiss, cells.use = rownames(tiss@meta.data[which(tiss@meta.data[,'region'] == 'normal'),]))
```

```{r, fig.height=10, fig.width=10}
ntiss <- ntiss %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss, pc.use = 9:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss)
```


```{r, fig.height=10, fig.width=10}
n.pcs = 20
res.use = 2
ntiss <- ntiss %>% FindClusters(reduction.type = "pca", dims.use = 1:n.pcs, 
    resolution = res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss, do.return = TRUE, group.by = "sample")
```


```{r, fig.width=10, fig.height=10}
genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2')

FeaturePlot(ntiss, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```


# Subclustering stromal cells

```{r, fig.height=10, fig.width=10}
cells.to.use = intersect(WhichCells(ntiss, c(3,9,13,21,22)), intersect(intersect(names(which(ntiss@data['EPCAM',] < 0.1)), names(which(ntiss@data['CLDN5',] < 0.1))), names(which(ntiss@data['PECAM1',] < 0.1))))

ntiss.stromal = SubsetData(ntiss, cells.use = cells.to.use)

```

```{r, fig.height=10, fig.width=10}
ntiss.stromal <- ntiss.stromal %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.stromal, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.stromal, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.stromal)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 6
normal.res.use = 4
ntiss.stromal <- ntiss.stromal %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/5) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.stromal, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "label")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.stromal, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=60, fig.width=10}

genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2', 'SERPINF1', 'PI16', 'SCARA5', 'SPINT2', 'FGFR4', 'ACTA2', 'CNN1', 'TAGLN', 'MYL9', 'CSPG4', 'HIGD1B', 'COX4I2', 'TRPC6', 'KCNK3', 'PDGFRA', 'PDGFRB', 'DES', 'KCNA5', 'LGR5', 'LGR6', 'FGF18', 'ASPN', 'PLIN2', 'APOE', 'MSLN', 'WT1', 'TOP2A', 'MKI67')

FeaturePlot(ntiss.stromal, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.stromal.markers <- FindAllMarkers(ntiss.stromal, min.pct = 0.25, thresh.use = 0.25, only.pos = T, test.use = 'MAST')

```


```{r, fig.height=60, fig.width=10}
genes_to_check <- ntiss.stromal.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.stromal.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.stromal, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.height=10, fig.width=10}
# Relying on lessons from mouse to call populations (a few representative markers are shown). All stromal cells are CD45- CD31- EPCAM-
# COX4I2+ HIGD1B+ GJA4+ CNN- -> Pericyte
# SLC38A5+ GDF10+ GPC3+ ITGA8+ -> Alveolar Fibroblast

# stash current cluster IDs
ntiss.stromal <- StashIdent(object = ntiss.stromal, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.stromal@ident)))
free_annotation <- c('Pericyte',
                     'Pericyte',
                     'Pericyte',
                     'Pericyte',
                     'Pericyte',
                     'Pericyte',
                     NA,
                     'Alveolar Fibroblast',
                     'Pericyte',
                     'Pericyte',
                     'Alveolar Fibroblast',
                     'Pericyte',
                     NA,
                     'Alveolar Fibroblast',
                     NA)

ntiss.stromal@meta.data[,'free_annotation'] <- NA
ntiss.stromal@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.stromal@ident, from = cluster.ids, to = free_annotation))

TSNEPlot(object = ntiss.stromal, do.label = T, pt.size = 2, label.size = 10, group.by = "free_annotation")
```


# Subclustering normal stromal cells (Round 2)

```{r, fig.height=10, fig.width=10}
ntiss.stromal.r2 = SubsetData(ntiss.stromal, ident.use = c(14,12,6))
```

```{r, fig.height=10, fig.width=10}
ntiss.stromal.r2 <- ntiss.stromal.r2 %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, x.low.cutoff = 2, do.contour = FALSE) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.stromal.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.stromal.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.stromal.r2)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 3
normal.res.use = 2
ntiss.stromal.r2 <- ntiss.stromal.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/2) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=20)

TSNEPlot(object = ntiss.stromal.r2, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.stromal.r2, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=60, fig.width=10}

genes_to_check = c('EPCAM', 'CLDN5', 'PTPRC', 'COL1A2', 'SERPINF1', 'PI16', 'SCARA5', 'SPINT2', 'FGFR4', 'ACTA2', 'CNN1', 'TAGLN', 'MYL9', 'CSPG4', 'HIGD1B', 'COX4I2', 'TRPC6', 'KCNK3', 'PDGFRA', 'PDGFRB', 'DES', 'KCNA5', 'ADAMTS4', 'LGR5', 'LGR6', 'FGF18', 'ASPN', 'PLIN2', 'APOE', 'MSLN', 'WT1', 'TOP2A', 'MKI67')

FeaturePlot(ntiss.stromal.r2, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.stromal.r2.markers <- FindAllMarkers(ntiss.stromal.r2, min.pct = 0.1, thresh.use = 0.1, only.pos = T, test.use = 'MAST')

```


```{r, fig.height=200, fig.width=10}
genes_to_check <- ntiss.stromal.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.stromal.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.stromal.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.height=10, fig.width=10}
# FGF18+ ASPN+ ACTA2mid -> Myofibroblast
# SERPINF1+ PI16+ FBLN1+ SCARA5+ SLC38A5- -> Adventitial Fibroblast
# ACTA2+ TAGLN+ CNN1+ MYL9+ KCNA5+ LGR6+ DES+ -> Airway Smooth Muscle
# ACTA2+ TAGLN+ CNN1+ MYL9+ GJA4+ KCNK3+  -> Vascular Smooth Muscle

# stash current cluster IDs
ntiss.stromal.r2 <- StashIdent(object = ntiss.stromal.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.stromal.r2@ident)))
free_annotation <- c('Vascular Smooth Muscle',
                     'Airway Smooth Muscle',
                     'Adventitial Fibroblast',
                     'Myofibroblast',
                     'Vascular Smooth Muscle')

ntiss.stromal.r2@meta.data[,'free_annotation'] <- NA
ntiss.stromal.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.stromal.r2@ident, from = cluster.ids, to = free_annotation))

TSNEPlot(object = ntiss.stromal.r2, do.label = T, pt.size = 2, label.size = 10, group.by = "free_annotation")
```

# Subclustering normal epithelial cells

```{r, fig.height=10, fig.width=10}
cells.to.use = WhichCells(ntiss, c(0,1,5,10,12,14,16))
cells.to.use = intersect(intersect(cells.to.use,names(which(ntiss@data['CLDN5',] < 0.1))),names(which(ntiss@data['TCF21',] < 0.1)))

ntiss.epi = SubsetData(ntiss, cells.use = cells.to.use)

```

```{r, fig.height=10, fig.width=10}
ntiss.epi <- ntiss.epi %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.epi, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.epi, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.epi)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 5
normal.res.use = 1
ntiss.epi <- ntiss.epi %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.epi, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.epi, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=70, fig.width=10}

genes_to_check = toupper(c('PTPRC', 'EPCAM', 'CLDN5', 'COL1A2', 'SFTPC', 'SFTPB', 'WIF1', 'HHIP', 'CA2', 'CP', 'CEACAM6', 'ETV5', 'ACTA2', 'PDPN', 'CLIC5', 'AGER', 'FOXJ1', 'TUBB4B', 'LINC01571', 'SCGB1A1', 'SCGB3A2', 'MUC5B', 'MUC5AC', 'FAM83D', 'SPDEF', 'SLC5A5', 'CHGA', 'CALCA', 'ASCL1', 'CFTR', 'ASCL3', 'PRR4', 'LPO', 'LTF', 'NGFR', 'TP63', 'KRT5', 'KRT14', 'SNCA', 'HES1', 'S100A2', 'MKI67', 'FOS', 'TCF21'))

FeaturePlot(ntiss.epi, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.epi.markers <- FindAllMarkers(ntiss.epi, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=160, fig.width=10}
genes_to_check <- ntiss.epi.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.epi.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.epi, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# Relying on canonical markers to call populations (a few representative markers are shown). All epithelial cells are CD45- CD31- Col1A1-
# SFP*+ ETV5+ MUC1+ -> Alveolar Epithelial Type 2 Cell
# HOPX+ PDPN+ CLIC5+ SPC*- -> Alveolar Epithelial Type 1 Cell
# FOXJ1+ TUBB4+ -> Ciliated
# KRT5+ KRT14+ -> Basal

# stash current cluster IDs
ntiss.epi <- StashIdent(object = ntiss.epi, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.epi@ident)))
free_annotation <- c(NA,
                     'Alveolar Epithelial Type 2',
                     'Ciliated',
                     'Alveolar Epithelial Type 2',
                     NA,
                     'Ciliated',
                     'Alveolar Epithelial Type 1',
                     'Alveolar Epithelial Type 2',
                     'Basal',
                     'Ciliated')


ntiss.epi@meta.data[,'free_annotation'] <- NA
ntiss.epi@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.epi@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss.epi, group.by = 'free_annotation', do.label = TRUE)

```

# Subclustering normal epithelial cells (Round 2)

```{r, fig.height=10, fig.width=10}
ntiss.epi.r2 = SubsetData(ntiss.epi, ident.use = c(0,4))

```

```{r, fig.height=10, fig.width=10}
ntiss.epi.r2 <- ntiss.epi.r2 %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.epi.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.epi.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.epi.r2)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 3
normal.res.use = 1
ntiss.epi.r2 <- ntiss.epi.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/10, k.param = 15) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.epi.r2, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.epi.r2, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.epi.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.epi.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.epi.r2, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.epi.r2, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=70, fig.width=10}

genes_to_check = toupper(c('PTPRC', 'EPCAM', 'CLDN5', 'COL1A2', 'SFTPC', 'SFTPB', 'WIF1', 'HHIP', 'CA2', 'CP', 'CEACAM6', 'ETV5', 'ACTA2', 'PDPN', 'CLIC5', 'AGER', 'FOXJ1', 'TUBB4B', 'LINC01571', 'SCGB1A1', 'SCGB3A2', 'MUC5B', 'MUC5AC', 'FAM83D', 'SPDEF', 'SLC5A5', 'CHGA', 'CALCA', 'ASCL1', 'CFTR', 'ASCL3', 'NGFR', 'TP63', 'KRT5', 'KRT14', 'SNCA', 'HES1', 'S100A2', 'MKI67', 'FOS', 'TCF21'))

FeaturePlot(ntiss.epi.r2, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.epi.r2.markers <- FindAllMarkers(ntiss.epi.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=160, fig.width=10}
genes_to_check <- ntiss.epi.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.epi.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.epi.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# SCGB1A1+ SCGB3A2+ SP*- FOXJ1- -> Club
# MUC5B+ SPDEF+ SLC5A5+ MUC5AC- -> Mucous

# stash current cluster IDs
ntiss.epi.r2 <- StashIdent(object = ntiss.epi.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.epi.r2@ident)))
free_annotation <- c('Mucous',
                     'Mucous',
                     'Club',
                     'Mucous',
                     'Mucous',
                     'Mucous',
                     'Club',
                     'Club')


ntiss.epi.r2@meta.data[,'free_annotation'] <- NA
ntiss.epi.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.epi.r2@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss.epi.r2, group.by = 'free_annotation', do.label = TRUE)

```


# Subclustering normal endothelial cells

```{r, fig.height=10, fig.width=10}
cells.to.use = WhichCells(ntiss, c(3,6,7,8,15,17))
cells.to.use = intersect(intersect(cells.to.use, names(which(ntiss@data['EPCAM',] < 0.1))), names(which(ntiss@data['COL1A2',] < 0.1)))


ntiss.endo = SubsetData(ntiss, cells.use = cells.to.use)

```

```{r, fig.height=10, fig.width=10}
ntiss.endo <- ntiss.endo %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, x.low.cutoff = 1) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.endo, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.endo, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.endo)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 7
normal.res.use = 1.25
ntiss.endo <- ntiss.endo %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T, plot.SNN = TRUE, prune.SNN = 1/5) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.endo, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.endo, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=60, fig.width=10}

genes_to_check = c('EPCAM', 'CLDN5', 'COL1A2', 'PTPRC', 'CXCL12', 'DKK2', 'CA4', 'GPIHBP1', 'SLC6A4', 'IL7R', 'EDNRB', 'SOSTDC1', 'HPGD', 'SOSTDC1', 'ACKR1', 'CPE', 'PDPN', 'PROX1', 'MMRN2', 'TOP2A', 'MKI67')

FeaturePlot(ntiss.endo, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.endo.markers <- FindAllMarkers(ntiss.endo, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=60, fig.width=10}
genes_to_check <- ntiss.endo.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.endo.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.endo, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```


## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
#Relying on lessons from mouse to call populations (a few representative markers are shown). All endothelial cells are CD45- EpCAM- Col1A1-
# IL7R+ SLC6A4+ FCN3+ C7- CPE- ACKR1- -> Capillary
# APLN+ EDNRB+ HPGD+ IL1RL1+  -> Capillary Aerocyte
# F2R+ DKK2+ SERPINE2+ -> Artery
# TFF3+ PDPN+ CCL21+ IGF1+ -> Lymphatic
# ACKR1+ CPE+ -> Vein

# stash current cluster IDs
ntiss.endo <- StashIdent(object = ntiss.endo, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.endo@ident)))
free_annotation <- c('Capillary Aerocyte',
                     'Capillary',
                     'Capillary Aerocyte',
                     'Capillary Aerocyte',
                     'Capillary Aerocyte',
                     'Capillary',
                     'Capillary Intermediate 1',
                     'Capillary',
                     'Capillary',
                     'Capillary Aerocyte',
                     'Capillary',
                     'Vein',
                     'Artery',
                     'Lymphatic')

ntiss.endo@meta.data[,'free_annotation'] <- NA
ntiss.endo@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.endo@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss.endo, group.by = 'free_annotation', do.label = TRUE)

```

# Subclustering normal immune cells

```{r, fig.height=10, fig.width=10}
ntiss.immune = SubsetData(ntiss, ident.use = c(4,20,13))
```

```{r, fig.height=10, fig.width=10}
ntiss.immune <- ntiss.immune %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, x.low.cutoff = 1) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune, pc.use = 9:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.immune)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 20
normal.res.use = 1.5
ntiss.immune <- ntiss.immune %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T, plot.SNN = TRUE, prune.SNN = 1/5) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.immune, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=120, fig.width=10}

genes_to_check = c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'GZMH', 'GZMB', 'GZMK', 'CCL5', 'GZMA', 'CD40LG', 'LDHB', 'LEF1', 'CCR7', 'KLRB1', 'TYROBP', 'NKG7', 'FCER1G', 'CD79A', 'CD19', 'MS4A1', 'CD24', 'JSRP1', 'SLAMF7', 'FCGR3B', 'MMP9', 'S100A8', 'MS4A2', 'CPA3', 'RGS13', 'SIGLEC8', 'MARCO', 'MSR1', 'MRC1', 'C1QA', 'LILRB4', 'IRF8', 'LRRC26', 'CLEC4C', 'SMPD3', 'GPR183', 'HLA-DPB1', 'CLEC9A', 'LAMP3', 'CD1C', 'PKIB', 'IGSF21', 'F13A1', 'EREG', 'CLEC5A', 'CHIT1', 'TREM2', 'CD14', 'VCAN', 'FCGR3A', 'CD300E', 'MKI67', 'TOP2A', 'GP9')

FeaturePlot(ntiss.immune, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.immune.markers <- FindAllMarkers(ntiss.immune, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=80, fig.width=10}
genes_to_check <- ntiss.immune.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:

```{r, fig.height=10, fig.width=10}
# stash current cluster IDs
ntiss.immune <- StashIdent(object = ntiss.immune, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune@ident)))
free_annotation <- c('Natural Killer',
                     'Natural Killer',
                     'Natural Killer',
                     'Natural Killer',
                     NA,
                     NA,
                     'Proliferating NK/T',
                     'Basophil/Mast 1')

ntiss.immune@meta.data[,'free_annotation'] <- NA
ntiss.immune@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune@ident, from = cluster.ids, to = free_annotation))

TSNEPlot(ntiss.immune, group.by = 'free_annotation', do.label = TRUE)
```



# Subclustering normal immune cells (Round 2)

```{r, fig.height=10, fig.width=10}
cells.to.use <- WhichCells(ntiss.immune, ident = 5)
cells.to.use <- intersect(cells.to.use, names(which(ntiss.immune@data['MS4A1',] < 0.1)))
ntiss.immune.r2 = SubsetData(ntiss.immune, cells.use = cells.to.use)

```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r2 <- ntiss.immune.r2 %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, do.contour = FALSE, x.low.cutoff = 5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune.r2, pc.use = 1:9, cells.use = 20, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune.r2, pc.use = 9:18, cells.use = 20, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.immune.r2)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 3
normal.res.use = 1
ntiss.immune.r2 <- ntiss.immune.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T, plot.SNN = TRUE, prune.SNN = 1/15, k.param = 5) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=10)

TSNEPlot(object = ntiss.immune.r2, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune.r2, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=120, fig.width=10}
genes_to_check = c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'GZMH', 'GZMB', 'GZMK', 'CCL5', 'GZMA', 'CD40LG', 'LDHB', 'LEF1', 'CCR7', 'KLRB1', 'TYROBP', 'NKG7', 'FCER1G', 'CD79A', 'CD19', 'MS4A1', 'CD24', 'JSRP1', 'SLAMF7', 'FCGR3B', 'MMP9', 'S100A8', 'MS4A2', 'CPA3', 'RGS13', 'SIGLEC8', 'MARCO', 'MSR1', 'MRC1', 'C1QA', 'LILRB4', 'IRF8', 'LRRC26', 'CLEC4C', 'SMPD3', 'GPR183', 'HLA-DPB1', 'CLEC9A', 'LAMP3', 'CD1C', 'PKIB', 'IGSF21', 'F13A1', 'EREG', 'CLEC5A', 'CHIT1', 'TREM2', 'CD14', 'VCAN', 'FCGR3A', 'CD300E', 'MKI67', 'TOP2A', 'GP9')

FeaturePlot(ntiss.immune.r2, genes_to_check, pt.size = 3, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r2.markers <- FindAllMarkers(ntiss.immune.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=70, fig.width=10}
genes_to_check <- ntiss.immune.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

```{r, fig.height=10, fig.width=10}
# CD3E+ CD4+ LTB+ LDHB+ CCR7+ LEF1+ COTL1- -> CD4+ Naive T Cell
# CD3E+ CD8+ GZMH+ GZMB+ LTB- IL7R- GZMK- DUSP2- -> CD8+ Naive T Cell
# CD3E+ NKG7+ KLR1B+ -> Natural Killer T

# stash current cluster IDs
ntiss.immune.r2 <- StashIdent(object = ntiss.immune.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune.r2@ident)))
free_annotation <- c("CD8+ Naive T",
                     "CD4+ Naive T",
                     "Natural Killer T")

ntiss.immune.r2@meta.data[,'free_annotation'] <- NA
ntiss.immune.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune.r2@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(object = ntiss.immune.r2, do.label = T, pt.size = 2, label.size = 10, group.by = "free_annotation")

```



# Subclustering normal immune cells (Round 3)

```{r, fig.height=10, fig.width=10}
ntiss.immune.r3 = SubsetData(ntiss.immune, ident.use = c(4))

```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r3 <- ntiss.immune.r3 %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5, do.contour = FALSE, x.low.cutoff = 3) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.immune.r3, pc.use = 1:9, cells.use = 20, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.immune.r3, pc.use = 9:18, cells.use = 20, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss.immune.r3)
```


```{r, fig.height=10, fig.width=10}
normal.n.pcs = 12
normal.res.use = 1
ntiss.immune.r3 <- ntiss.immune.r3 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs, 
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = T, plot.SNN = TRUE, k.param = 2, prune.SNN = 1/15) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=10)

TSNEPlot(object = ntiss.immune.r3, do.label = T, pt.size = 2, label.size = 10)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.immune.r3, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=120, fig.width=10}

genes_to_check = c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'GZMH', 'GZMB', 'GZMK', 'CCL5', 'GZMA', 'CD40LG', 'LDHB', 'LEF1', 'CCR7', 'KLRB1', 'TYROBP', 'NKG7', 'FCER1G', 'CD79A', 'CD19', 'MS4A1', 'CD24', 'JSRP1', 'SLAMF7', 'FCGR3B', 'MMP9', 'S100A8', 'IL1R2', 'MS4A2', 'CPA3', 'RGS13', 'SIGLEC8', 'MARCO', 'MSR1', 'MRC1', 'C1QA', 'LILRB4', 'IRF8', 'LRRC26', 'CLEC4C', 'SMPD3', 'GPR183', 'HLA-DPB1', 'CLEC9A', 'LAMP3', 'CD1C', 'PKIB', 'IGSF21', 'F13A1', 'EREG', 'CLEC5A', 'CHIT1', 'TREM2', 'CD14', 'VCAN', 'FCGR3A', 'CD300E', 'MKI67', 'TOP2A', 'GP9', 'nGene')

FeaturePlot(ntiss.immune.r3, genes_to_check, pt.size = 3, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.height=10, fig.width=10}
ntiss.immune.r3.markers <- FindAllMarkers(ntiss.immune.r3, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=50, fig.width=10}
genes_to_check <- ntiss.immune.r3.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss.immune.r3.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss.immune.r3, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:

```{r, fig.height=10, fig.width=10}
# LGALS2+ CD14+ NRG1+ S100A8+ S100A9+ S100A12+ -> Classical Monocyte
# CDKN1C+ CD79B+ LYPD2+ CHST2+ IFITM2+ HES4+ CD16+ -> Nonclassical Monocyte
# CD14+ CD16+ GPR183+ IGSF21+ F13A1+ -> IGSF21+ Dendritic
# MARCO+ MRC1+ MSR1+ C1QA+ -> Macrophage
# FCGR3B+ S100A8+ IL1R2+ -> Neutrophil
# IRF8+ SMPD3+ CLEC4C+ -> Plasmacytoid Dendritic

# stash current cluster IDs
ntiss.immune.r3 <- StashIdent(object = ntiss.immune.r3, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss.immune.r3@ident)))
free_annotation <- c("Macrophage",
                     "Macrophage",
                     "Macrophage",
                     "Neutrophil",
                     "Plasmacytoid Dendritic",
                     "Intermediate Monocyte",
                     "Nonclassical Monocyte",
                     "IGSF21+ Dendritic")

ntiss.immune.r3@meta.data[,'free_annotation'] <- NA
ntiss.immune.r3@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss.immune.r3@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(object = ntiss.immune.r3, do.label = T, pt.size = 2, label.size = 10, group.by = "free_annotation")

```


# Combine all subclustering annotaitons

```{r, fig.height=10, fig.width=10}
ntiss@meta.data[,'free_annotation'] <- NA

ntiss@meta.data[names(which(ntiss.immune@data['MS4A1',] > 1)),'free_annotation'] <- 'B'

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.epi@meta.data)),'free_annotation'] <- ntiss.epi@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.epi@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.epi.r2@meta.data)),'free_annotation'] <- ntiss.epi.r2@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.epi.r2@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.endo@meta.data)),'free_annotation'] <- ntiss.endo@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.endo@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal@meta.data)),'free_annotation'] <- ntiss.stromal@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal.r2@meta.data)),'free_annotation'] <- ntiss.stromal.r2@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.stromal.r2@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune@meta.data)),'free_annotation'] <- ntiss.immune@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r2@meta.data)),'free_annotation'] <- ntiss.immune.r2@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r2@meta.data)),'free_annotation']

ntiss@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r3@meta.data)),'free_annotation'] <- ntiss.immune.r3@meta.data[intersect(rownames(ntiss@meta.data[which(is.na(ntiss@meta.data[,'free_annotation'])),]),rownames(ntiss.immune.r3@meta.data)),'free_annotation']

```


```{r, fig.height=10, fig.width=10}
TSNEPlot(ntiss, do.label = T, group.by = 'free_annotation', no.legend = TRUE)
```

# Removing suspected doublets

```{r, fig.height=10, fig.width=10}
ntiss.anno = SubsetData(ntiss, cells.use = rownames(ntiss@meta.data[which(!is.na(ntiss@meta.data[,'free_annotation'])),]))
```

```{r, fig.height=10, fig.width=10}
ntiss.anno <- ntiss.anno %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.height=10, fig.width=10}
PCHeatmap(object = ntiss.anno, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.anno, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss.anno, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

PCElbowPlot(ntiss.anno, num.pc = 30)
```


```{r, fig.height=10, fig.width=10}
n.pcs = 20
res.use = 2
ntiss.anno <- ntiss.anno %>%
    RunTSNE(dims.use = 1:n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss.anno, do.label = T, pt.size = 1.2, label.size = 4, group.by = 'free_annotation', no.legend = TRUE)

```

```{r, fig.height=10, fig.width=10}
# Batch and animal effects
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "sorter")
TSNEPlot(object = ntiss.anno, do.return = TRUE, group.by = "sample")
```


```{r, fig.height=10, fig.width=10}

genes_to_check = c('EPCAM', 'PTPRC', 'PECAM1', 'COL1A2')

FeaturePlot(ntiss.anno, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols)

```

```{r, fig.height=10, fig.width=10}
# Fix metadata column names
ntiss.anno@meta.data[,'res.2'] <- NULL
colnames(ntiss.anno@meta.data) <- colnames(tiss@meta.data)[-137]
ntiss.anno <- SetIdent(ntiss.anno, ident.use = ntiss.anno@meta.data$free_annotation)
ntiss.anno@meta.data$gating <- rep('NA', 3273)

```

# Save the Robject for later
When you save the annotated tissue, please give it a name.

```{r, fig.height=10, fig.width=10}
ntiss.P2.anno.gencode <- ntiss.anno
filename = here('seurat', paste0("facs_normal_lung_seurat_ntiss.P2.anno.gencode.20191002.RC4.Robj"))
print(filename)
save(ntiss.P2.anno.gencode, file=filename)
```
























