---
title: "The Human Lung Cell Atlas (10X)"
output:
  html_document: default
  html_notebook: default
---
# All Package versions used


```{r, fig.width=10, fig.height=10}
installed.packages()[,'Version']

```

# Specify the tissue of interest, run the boilerplate code which sets up the functions and environment, load the tissue object.


```{r, fig.width=10, fig.height=10}
tissue_of_interest = "all"
library(here)
source(here("boilerplate.R"))
tiss10x <- load_tissue_droplet(tissue_of_interest)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = tiss10x, pc.use = 1:9, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = tiss10x, pc.use = 10:18, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
```

```{r, fig.width=10, fig.height=10}
PCElbowPlot(object = tiss10x)
```

```{r, fig.width=10, fig.height=10}
# Set number of principal components.
n.pcs = 20
```

```{r, fig.width=10, fig.height=10}
# Set resolution
res.used <- 2

tiss10x <- FindClusters(object = tiss10x, reduction.type = "pca", dims.use = 1:n.pcs,
    resolution = res.used, print.output = 0, save.SNN = TRUE)
```

```{r, fig.width=10, fig.height=10}
tiss10x <- RunTSNE(object = tiss10x, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)
```


```{r, fig.width=10, fig.height=10}
# note that you can set do.label=T to help label individual clusters
TSNEPlot(object = tiss10x, do.label = T, no.legend = T)
```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = tiss10x, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = tiss10x, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = tiss10x, do.return = TRUE, group.by = "region")
TSNEPlot(object = tiss10x, do.return = TRUE, group.by = "area")
TSNEPlot(object = tiss10x, do.return = TRUE, group.by = "compartment")
```

Check expression of genes of interset.

```{r, fig.height=15, fig.width=10}
genes_to_check = toupper(c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'krt5','tp63'))
FeaturePlot(tiss10x, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols)
```

How big are the clusters?
```{r, fig.width=10, fig.height=10}
table(tiss10x@ident)
```

# Subclustering normal cells

```{r, fig.width=10, fig.height=10}
ntiss10x <- SubsetData(tiss10x, cells.use = rownames(tiss10x@meta.data[which(tiss10x@meta.data[,'region'] %in% c('Normal')),]))

```

```{r, fig.width=10, fig.height=10}
ntiss10x <- ntiss10x %>% # Removed scale data since no tumor cells were loaded / to save memory (Kyle)
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30 ) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

PCElbowPlot(ntiss10x, num.pc = 30)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 30
normal.res.use = 2
ntiss10x <- ntiss10x %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30, force.recalc = TRUE)

TSNEPlot(object = ntiss10x, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=40, fig.width=10}

genes_to_check = toupper(c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'KLRB1', 'AREG', 'CHST2', 'CD79A', 'CD19', 'MS4A1', 'CD24', 'CD68', 'FCGR3A', 'CD14', 'MARCO', 'MSR1', 'MRC1', 'MKI67', 'FCER1G', 'CPA3', 'RGS13','alas2','pdcd1','cd274'))

FeaturePlot(ntiss10x, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T)

```

# Subclustering normal stromal cells

```{r, fig.width=10, fig.height=10}
cells.to.use <- WhichCells(ntiss10x, ident = c(6,16,19,26,31))
cells.to.use <- intersect(cells.to.use, names(which(ntiss10x@data['S100A8',] < 0.1)))
ntiss10x.stromal = SubsetData(ntiss10x, cells.use = cells.to.use)
```

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal <- ntiss10x.stromal %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.stromal, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.stromal, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.stromal)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 10
normal.res.use = 1
ntiss10x.stromal <- ntiss10x.stromal %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.stromal, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.stromal, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.stromal, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.stromal, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.stromal, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.stromal, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=50, fig.width=10}

genes_to_check = toupper(c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Serpinf1', 'TCF21', 'PDGFRA', 'PDGFRB', 'CNN1', 'TRPC6', 'SLC38a5', 'PI16', 'Serpinf1', 'HP', 'FGF18', 'SCARA5', 'MSLN', 'WIF1', 'WNT5a', 'Pcsk1n'))

FeaturePlot(ntiss10x.stromal, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.markers <- FindAllMarkers(ntiss10x.stromal, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=120, fig.width=10}
genes_to_check <- ntiss10x.stromal.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.stromal.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.stromal, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
#At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
#Relying on lessons from mouse to call populations (a few representative markers are shown). All stromal cells are CD45- #CD31- EpCAM-

#ACTA2+ MYH11+ ASPN+ TYRP1+ FGF18+ -> Myofibroblast


# stash current cluster IDs
ntiss10x.stromal <- StashIdent(object = ntiss10x.stromal, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.stromal@ident)))
free_annotation <- c(NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     'Myofibroblast',
                     NA,
                     NA,
                     NA,
                     NA,
                     NA)

ntiss10x.stromal@meta.data[,'free_annotation'] <- NA
ntiss10x.stromal@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.stromal@ident, from = cluster.ids, to = free_annotation))
```



# Subclustering normal stromal cells (Round 2, Fibroblasts)

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.r2 = SubsetData(ntiss10x.stromal, ident.use = c(1,3,6,8,9))
```

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.r2 <- ntiss10x.stromal.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.stromal.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.stromal.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.stromal.r2)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 6
normal.res.use = 0.5
ntiss10x.stromal.r2 <- ntiss10x.stromal.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/5) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.stromal.r2, do.label = T, pt.size = 3, label.size = 10)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.stromal.r2, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.stromal.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.stromal.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.stromal.r2, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.stromal.r2, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=50, fig.width=10}

genes_to_check = toupper(c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Serpinf1', 'Plin2', 'PDGFRA', 'PDGFRB', 'CNN1', 'TRPC6', 'SLC38a5', 'PI16', 'Serpinf1', 'HP', 'FGF18', 'SCARA5', 'MSLN', 'WIF1', 'WNT5a', 'Pcsk1n'))

FeaturePlot(ntiss10x.stromal.r2, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.r2.markers <- FindAllMarkers(ntiss10x.stromal.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=60, fig.width=10}
genes_to_check <- ntiss10x.stromal.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.stromal.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.stromal.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
#At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
#Relying on lessons from mouse to call populations (a few representative markers are shown). All stromal cells are CD45- #CD31- EpCAM-
#SLC38A5+ GDF10+ GPC3+ ITGA8+ -> Alveolar Fibroblasts
#SERPINF1+ PI16+ FBLN1+ SCARA5+ SLC38A5- -> Adventitial Fibroblasts

# stash current cluster IDs
ntiss10x.stromal.r2 <- StashIdent(object = ntiss10x.stromal.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.stromal.r2@ident)))
free_annotation <- c('Alveolar Fibroblast',
                     'Alveolar Fibroblast',
                     'Alveolar Fibroblast',
                     'Adventitial Fibroblast',
                     'Adventitial Fibroblast',
                     'Adventitial Fibroblast')

ntiss10x.stromal.r2@meta.data[,'free_annotation'] <- NA
ntiss10x.stromal.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.stromal.r2@ident, from = cluster.ids, to = free_annotation))
```




# Subclustering normal stromal cells (Round 3, SMCs & Pericytes)

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.r3 = SubsetData(ntiss10x.stromal, ident.use = c(0,4,12,2,11))
```

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.r3 <- ntiss10x.stromal.r3 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.stromal.r3, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.stromal.r3, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.stromal.r3)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 6
normal.res.use = 1
ntiss10x.stromal.r3 <- ntiss10x.stromal.r3 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/15) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.stromal.r3, do.label = T, pt.size = 3, label.size = 10)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.stromal.r3, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.stromal.r3, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.stromal.r3, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.stromal.r3, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.stromal.r3, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=50, fig.width=10}

genes_to_check = toupper(c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Serpinf1', 'Plin2', 'PDGFRA', 'PDGFRB', 'ACTA2', 'CNN1', 'TRPC6', 'SLC38a5', 'PI16', 'Serpinf1', 'HP', 'FGF18', 'SCARA5', 'MSLN', 'WIF1', 'DES', 'LGR6', 'KCNA5', 'ADAMTS4', 'RRAD', 'MT1M'))

FeaturePlot(ntiss10x.stromal.r3, genes_to_check, pt.size = 2, nCol = 2, cols.use = my.cols, dark.theme = TRUE)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.stromal.r3.markers <- FindAllMarkers(ntiss10x.stromal.r3, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=60, fig.width=10}
genes_to_check <- ntiss10x.stromal.r3.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.stromal.r3.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.stromal.r3, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
#At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
#Relying on lessons from mouse to call populations (a few representative markers are shown). All stromal cells are CD45- #CD31- EpCAM-

#COX4I2+ HIGD1B+ GJA4+ TAGLN- CNN- -> Pericytes
#ACTA2+ TAGLN+ CNN1+ MYH11+ LGR6+ DES+ -> Airway Smooth Muscle
#ACTA2+ TAGLN+ CNN1+ MYH11+ KRT18+ KGR6- DES- -> Airway Smooth Muscle

#ACTA2+ MYH11+ ASPN+ TYRP1+ CNN1+ TAGLN+ -> Myofibroblast (Proximal)


# stash current cluster IDs
ntiss10x.stromal.r3 <- StashIdent(object = ntiss10x.stromal.r3, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.stromal.r3@ident)))
free_annotation <- c('Airway Smooth Muscle',
                     "Pericyte",
                     "Pericyte",
                     "Vascular Smooth Muscle",
                     "Vascular Smooth Muscle",
                     "Proximal Myofibroblast",
                     "Vascular Smooth Muscle",
                     "Airway Smooth Muscle")

ntiss10x.stromal.r3@meta.data[,'free_annotation'] <- NA
ntiss10x.stromal.r3@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.stromal.r3@ident, from = cluster.ids, to = free_annotation))
```


# Subclustering normal epithelial cells

```{r, fig.width=10, fig.height=10}
ntiss10x.epi = SubsetData(ntiss10x, ident.use = c(13,8,1,5,36,22,41,33,27,18))
```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi <- ntiss10x.epi %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.epi, pc.use = 1:9, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.epi, pc.use = 10:18, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.epi)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 10
normal.res.use = 1
ntiss10x.epi <- ntiss10x.epi %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.epi, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.epi, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.epi, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.epi, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.epi, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.epi, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=85, fig.width=10}

genes_to_check = toupper(c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Muc5ac', 'Muc5b','dclk1','atoh1','vsig1','spdef' , 'SFTPC', 'ETV5', 'ager', 'emp2', 'scel', 'FOXJ1', 'TUBB4B', 'SCGB1A1','wfdc2','pigr','cyp2b7p', 'SCGB3A2', 'WIF1', 'HHIP', 'SERPINA1', 'KRT5', 'NGFR', 'KRT7','tp63','il33','dlk2','ascl3','foxi1','pou2f3','foxe1','etv1','ascl2','trpm5'))

FeaturePlot(ntiss10x.epi, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.markers <- FindAllMarkers(ntiss10x.epi, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=60, fig.width=10}
genes_to_check <- ntiss10x.epi.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.epi.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)

#FeaturePlot(ntiss10x.epi, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters

```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# Relying on canonical markers to call populations (a few representative markers are shown). All epithelial cells are CD45- CD31- Col1A1-


# stash current cluster IDs
ntiss10x.epi <- StashIdent(object = ntiss10x.epi, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.epi@ident)))
free_annotation <- c(NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     
                     NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     
                     NA,
                     NA,
                     NA,
                     NA,
                     NA)

ntiss10x.epi@meta.data[,'free_annotation'] <- NA

```



# Subclustering normal epithelial cells (Round 2)

```{r, fig.width=10, fig.height=10}
cell.to.use <- WhichCells(ntiss10x.epi, c(11,7,9,12,13,15,3,14,10,6))
cell.to.use <- intersect(cell.to.use, names(which(ntiss10x.epi@data['NKG7',] < 1.2)))
ntiss10x.epi.r2 = SubsetData(ntiss10x.epi, cells.use = cell.to.use)
```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.r2 <- ntiss10x.epi.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=7}
PCHeatmap(object = ntiss10x.epi.r2, pc.use = 1:9, cells.use = 300, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.epi.r2, pc.use = 10:18, cells.use = 300, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.epi.r2, pc.use = 19:20, cells.use = 300, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.epi.r2, num.pc = 20)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 18
normal.res.use = 2.5
ntiss10x.epi.r2 <- ntiss10x.epi.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.epi.r2, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.epi.r2, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.epi.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.epi.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.epi.r2, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.epi.r2, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=50, fig.width=10}

genes_to_check = toupper(c('Muc5ac', 'muc5b', 'spdef', 'hes1', "Lcn2", "Bpifb1", "Muc4", 'scgb1a1', 'scgb3a2', 'cyp2b7p', 'pigr', 'gdf15', 'dlk2','krt5', 'ripk4' ,'top2a','ALDH5A1','ager','abca3', 'Krt7', 'Hes1', 'Foxj1', 'Muc12', 'Calca', 'Chga', 'Foxi1'))

FeaturePlot(ntiss10x.epi.r2, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.r2.markers <- FindAllMarkers(ntiss10x.epi.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=200, fig.width=10}
genes_to_check <- ntiss10x.epi.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
#ntiss10x.epi.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.epi.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# There is still considerable heterogeneity among the cells, but we don't have enough cells to go further with Seurat
# SFP*+ ETV5+ MUC1+ -> Alveolar Epithelial Type II Cell
# HOPX+ PDPN+ CLIC5+ SPC*- -> Alveolar Epithelial Type I Cell
# SCGB1A1+ SCGB3A2+ SP*- FOXJ1- -> Club Cells
# MUC5AC+ SPEDF+ MUC5B+ -> Goblet Cell
# MUC5AC+ SPEDF+ MUC12+ -> MUC12+ Goblet Cell
# FOXJ1+ TUBB4+ -> Ciliated Cell
# KRT5+ KRT14+ -> Basal Cells
# HES1+ KRT7+ -> Differentiating Basal Cell
# ASCL3+ FOXI1+ CFTR+ -> Ionocyte
#  -> Serous Cell
# # MUC5B+ SPEDF+ -> Mucous Cell


# stash current cluster IDs
ntiss10x.epi.r2 <- StashIdent(object = ntiss10x.epi.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.epi.r2@ident)))
free_annotation <- c('Ciliated',#0
                     'Club',
                     'Club',
                      NA,
                     'Ciliated',#4
                      NA,#5
                     'Goblet',#6
                     'Proximal Basal',#7
                     'Proximal Differentiating Basal',#8
                     'Mucous',#9
                     'Club',#10
                     'Basal',#11
                     'Basal',#12
                      NA,#13
                     'MUC12+ Ciliated',#14
                      NA,#15
                     'Differentiating Basal',#16
                      NA,#17
                     'Proliferating Basal',#18
                      NA,#19
                     'Serous',#20
                     'Platelet/Megakaryocyte')

ntiss10x.epi.r2@meta.data[,'free_annotation'] <- NA
ntiss10x.epi.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.epi.r2@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.epi.r2, group.by = "free_annotation", do.label = TRUE)
```

# Subclustering normal epithelial cells (Round 3)

```{r, fig.width=10, fig.height=10}
cell.to.use <- WhichCells(ntiss10x.epi.r2, c(19))
#cell.to.use <- intersect(cell.to.use, names(which(ntiss10x.epi@data['NKG7',] < 1.2)))
ntiss10x.epi.r3 = SubsetData(ntiss10x.epi.r2, cells.use = cell.to.use)
```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.r3 <- ntiss10x.epi.r3 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 5) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.epi.r3, pc.use = 1:5, cells.use = 10, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.epi.r3, num.pc = 5)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 2
normal.res.use = 1
ntiss10x.epi.r3 <- ntiss10x.epi.r3 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/1.1) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=10)

TSNEPlot(object = ntiss10x.epi.r3, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.epi.r3, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.epi.r3, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.epi.r3, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.epi.r3, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.epi.r3, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=10, fig.width=10}

genes_to_check = toupper(c('Foxi1', 'Ascl3', 'Ascl1', 'Chga'))

FeaturePlot(ntiss10x.epi.r3, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.r3.markers <- FindAllMarkers(ntiss10x.epi.r3, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=10, fig.width=10}
genes_to_check <- ntiss10x.epi.r3.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.epi.r3.markers %>% group_by(cluster) %>% top_n(-20, p_val_adj)
FeaturePlot(ntiss10x.epi.r3, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# There is still considerable heterogeneity among the cells, but we don't have enough cells to go further with Seurat
# ASCL3+ FOXI1+ -> Ionocyte
# ASCL1+ CHGA+ -> Neuroendocrine Cell

# stash current cluster IDs
ntiss10x.epi.r3 <- StashIdent(object = ntiss10x.epi.r3, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.epi.r3@ident)))
free_annotation <- c("Ionocyte",#0
                     "Neuroendocrine") #1
                  
                                          

ntiss10x.epi.r3@meta.data[,'free_annotation'] <- NA
ntiss10x.epi.r3@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.epi.r3@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.epi.r3, group.by = "free_annotation")
```




# Subclustering normal epithelial cells (Round 4)

```{r, fig.width=10, fig.height=10}
cell.to.use <- WhichCells(ntiss10x.epi, c(4,1,5,2,7,0,3))
#cell.to.use <- intersect(cell.to.use, names(which(ntiss10x.epi@data['NKG7',] < 1.2)))
ntiss10x.epi.r4 = SubsetData(ntiss10x.epi, cells.use = cell.to.use)
```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.r4 <- ntiss10x.epi.r4 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.epi.r4, pc.use = 1:9, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.epi.r4, pc.use = 10:18, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.epi.r4)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 6
normal.res.use = 0.5
ntiss10x.epi.r4 <- ntiss10x.epi.r4 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, prune.SNN = 1/4, plot.SNN =  TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.epi.r4, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.epi.r4, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.epi.r4, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.epi.r4, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.epi.r4, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.epi.r4, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=30, fig.width=10}

genes_to_check = toupper(c('sftpc', 'ager', 'scgb3a2', 'cyp2b7p', 'pigr', 'ager', 'hhip', 'ca2','wif1','tcf7l2','slc22a3','hmgcs2' , 'foxj1' ,'krt5', 'mki67'))

FeaturePlot(ntiss10x.epi.r4, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.epi.r4.markers <- FindAllMarkers(ntiss10x.epi.r4, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=150, fig.width=10}
genes_to_check <- ntiss10x.epi.r4.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.epi.r4.markers %>% group_by(cluster) %>% top_n(-20, p_val_adj)
FeaturePlot(ntiss10x.epi.r4, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = TRUE)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# There is still considerable heterogeneity among the cells, but we don't have enough cells to go further with Seurat
# WIF1+ HHIP+ SFTPC+ AGER- <- AT2
# CP+ SFTPC+ WIF1- HHIP2- AGER- <- Noncanonical AT2
# AGER+ CLIC5+ CLDN18+ EMP2 <- AT1

# stash current cluster IDs
ntiss10x.epi.r4 <- StashIdent(object = ntiss10x.epi.r4, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.epi.r4@ident)))
free_annotation <- c("Noncanonical Alveolar Epithelial Type 2",#0
                     'Alveolar Epithelial Type 1',#1
                     "Alveolar Epithelial Type 2",#2
                     "Alveolar Epithelial Type 2",#3
                     "Alveolar Epithelial Type 2",#4
                     "Club",#5
                     "Alveolar Epithelial Type 2",#6
                     "Alveolar Epithelial Type 2",#7
                     "Alveolar Epithelial Type 2",#8
                     "Club",#9
                     "Alveolar Epithelial Type 2",
                     "Alveolar Epithelial Type 2",
                     "Alveolar Epithelial Type 1")#10
                  
                                          

ntiss10x.epi.r4@meta.data[,'free_annotation'] <- NA
ntiss10x.epi.r4@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.epi.r4@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.epi.r4, group.by = "free_annotation")
```



# Subclustering normal endothelial cells

```{r, fig.width=10, fig.height=10}
cells.to.use = WhichCells(ntiss10x, ident = c(4,11,25,28,34,35,39))
cells.to.use = intersect(intersect(cells.to.use, names(which(ntiss10x@data['PTPRC',cells.to.use] < 0.1))), names(which(ntiss10x@data['EPCAM',cells.to.use] < 0.1)))


ntiss10x.endo = SubsetData(ntiss10x, cells.use = cells.to.use)
```


```{r, fig.width=10, fig.height=10}
ntiss10x.endo <- ntiss10x.endo %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.endo, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.endo, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCElbowPlot(ntiss10x.endo)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 9
normal.res.use =0.5
ntiss10x.endo <- ntiss10x.endo %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.endo, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.endo, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.endo, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.endo, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.endo, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.endo, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=45, fig.width=10}

genes_to_check = toupper(c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Cxcl12', 'Dkk2', 'Gja5', 'Slc6a4', 'Gpihbp1', 'Aplnr', 'Apln', 'Ednrb', 'Myc', 'Spry1', 'Ackr1', 'Rspo3', 'Ptgis', 'Prox1', 'PDPN', 'CTNNB1', 'FOS'))

FeaturePlot(ntiss10x.endo, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.endo.markers <- FindAllMarkers(ntiss10x.endo, min.pct = 0.25, thresh.use = 0.25, only.pos = T)

```


```{r, fig.height=80, fig.width=10}
genes_to_check <- ntiss10x.endo.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.endo.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.endo, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
#
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# Relying on lessons from mouse to call populations (a few representative markers are shown). All endothelial cells are CD45- EpCAM- Col1A1-
# IL7R+ SLC6A4+ FCN3+ C7- CPE- ACKR1- -> Capillary Type I Cell
# APLN+ EDNRB+ HPGD+ IL1RL1+  -> Capillary Type II Cell
# CXCL12+ DKK2+ GJA5+ SERPINE2+ -> Artery Cell
# RSPO+ ACKR1+ PTGIS+ PTDGS+ CPE+ -> Vein Cell
# TFF3+ PDPN+ CCL21+ IGF1+ -> Lymphatic Cell
#
# Not seen in mouse:
#
# MYC+ SPRY1+ -> Endothelial Cell (Myc+)
# MYC+ SPRY1- -> Endothelial Cell II (Myc+)


# stash current cluster IDs
ntiss10x.endo <- StashIdent(object = ntiss10x.endo, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.endo@ident)))
free_annotation <- c("Capillary 1",
                     "Capillary 2",
                     "Bronchial Vessel",
                     "Artery",
                     "Vein",
                     "Lymphatics",
                     "MYC+ ACKR1- Vessel")

ntiss10x.endo@meta.data[,'free_annotation'] <- NA
ntiss10x.endo@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.endo@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.endo, group.by = "free_annotation", do.label = TRUE)
```

# Subclustering normal immune cells

```{r, fig.width=10, fig.height=10}
ntiss10x.immune = SubsetData(ntiss10x, ident.use = c(0,12,14,17,29,21,40,24,30,7,37,20,23,3,10,9,2,15,32,38,39))
```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune <- ntiss10x.immune %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.immune, pc.use = 1:9, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune, pc.use = 10:18, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune, pc.use = 19:27, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

PCElbowPlot(ntiss10x.immune, num.pc = 30)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 25
normal.res.use = 1.5
ntiss10x.immune <- ntiss10x.immune %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=20)

TSNEPlot(object = ntiss10x.immune, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.immune, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.immune, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.immune, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.immune, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.immune, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=80, fig.width=10}

genes_to_check = toupper(c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'KLRB1', 'AREG', 'CHST2', 'CD79A', 'CD19', 'MS4A1', 'CD24', 'CD68', 'FCGR3A', 'CD14', 'MARCO', 'MSR1', 'MRC1', 'MKI67', 'FCER1G', 'CPA3', 'RGS13','alas2','tubb1','ppbp','cd34','mme','g0s2','TPSAB1','ENPP3'))


FeaturePlot(ntiss10x.immune, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T, no.legend = T)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.markers <- FindAllMarkers(ntiss10x.immune, min.pct = 0.25, thresh.use = 0.25, only.pos = T, max.cells.per.ident = 200)

```


```{r, fig.height=500, fig.width=10}
#genes_to_check <- ntiss10x.immune.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.immune.markers %>% group_by(cluster) %>% top_n(10, avg_logFC)
#FeaturePlot(ntiss10x.immune, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# Calling immune cells based on canonical markers and bulk RNAseq data from the Weissman Lab (Rahul said this could be made available, if needed). All immune cells are EpCAM- Col1a1-, some are CD31+
# CD79A+ CD27+ CD24- MS4A1- CD19- -> Plasma Cell


# stash current cluster IDs
ntiss10x.immune <- StashIdent(object = ntiss10x.immune, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.immune@ident)))
free_annotation <- c('Macrophage',#0
                     'Macrophage',#1
                     NA,#2
                     NA,#3
                     NA,#4
                     NA,#5
                     NA,#6
                     NA,#7
                     NA,#8
                     NA,#9
                     'Mast Cell/Basophil Type 1',#10
                     "B",#11
                     NA,#12
                     'Mast Cell/Basophil Type 2',#13
                     'Macrophage',#14
                     'Macrophage',#15
                     NA,#16
                     'Macrophage',#17
                     NA,#18
                     NA,#19
                     NA,#20
                     NA,#21
                     "Plasma",#22
                     NA,#23
                     'Proliferating Macrophage',#24
                     NA,#25
                     NA,#26
                     'Plasmacytoid Dendritic',#27
                     NA#28
                     )

ntiss10x.immune@meta.data[,'free_annotation'] <- NA
ntiss10x.immune@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.immune@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.immune, group.by = "free_annotation")
```

# Subclustering normal immune cells (T cells)

```{r, fig.width=10, fig.height=10}
cells.to.use <- WhichCells(ntiss10x.immune, ident = c(19,20,2,9,4,3,18,7,8))
ntiss10x.immune.Tcells = SubsetData(ntiss10x.immune, cells.use = cells.to.use)
```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.Tcells <- ntiss10x.immune.Tcells %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.immune.Tcells, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune.Tcells, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune.Tcells, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

PCElbowPlot(ntiss10x.immune.Tcells, num.pc = 30)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 9
normal.res.use = 1
ntiss10x.immune.Tcells <- ntiss10x.immune.Tcells %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/10) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=40)

TSNEPlot(object = ntiss10x.immune.Tcells, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.immune.Tcells, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.immune.Tcells, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.immune.Tcells, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.immune.Tcells, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.immune.Tcells, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=70, fig.width=10}


genes_to_check = toupper(c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'KLRB1','CHST2', 'MKI67', 'FCER1G', 'TYROBP', 'AREG', 'HOPX', 'LTB', 'COTL1', 'LDHB', 'CCR7', 'LEF1', 'GZMH', 'GZMB', 'IL7R', 'GZMK', 'DUSP2'))

FeaturePlot(ntiss10x.immune.Tcells, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T, no.legend = T)


```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.Tcells.markers <- FindAllMarkers(ntiss10x.immune.Tcells, min.pct = 0.25, thresh.use = 0.25, only.pos = T, max.cells.per.ident = 200)

```


```{r, fig.height=140, fig.width=10}
genes_to_check <- ntiss10x.immune.Tcells.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.immune.Tcells.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.immune.Tcells, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# FCER1G+ TYROBP+ GZMB+ AREG+ HOPX+ CD3E- -> Less Mature Natural Killer Cell (Lung)
# FCER1G+ TYROBP+ GZMB+ CHST2+ HOPX+ AREG- CD3E- -> Mature Natural Killer Cell
# CD3E+ CD4+ LTB+ COTL1+ LDHB+ CCR7- LEF1- -> CD4+ Memory T Cell
# CD3E+ CD4+ LTB+ LDHB+ CCR7+ LEF1+ COTL1- -> CD4+ Naive T Cell
# CD3E+ CD8+ GZMH+ GZMB+ LTB- IL7R- GZMK- DUSP2- -> CD8+ Naive T Cell
# CD3E+ CD8+ GZMK+ KLRB1+ IL7R+ DUSP2+ GZMH- GZMB- -> CD8+ Memory T Cell
# CD3E+ CD8+ FCER1G+ TYROBP+ -> Natural Killer T Cell


# stash current cluster IDs
ntiss10x.immune.Tcells <- StashIdent(object = ntiss10x.immune.Tcells, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.immune.Tcells@ident)))
free_annotation <- c("Itinerant CD4+ Memory T",#0
                     'Itinerant Natural Killer',#1
                     NA,#2
                     NA,#3
                     NA,#4
                     NA,#5
                     "Circulating CD4+ Naive T",#6
                     "Circulating Natural Killer",#7
                     "Itinerant CD4+ Memory T",#8
                     "Circulating CD4+ Memory T",#9
                     'Itinerant CD4+ Memory T',#10
                     "Itinerant Natural Killer T",#11
                     NA,#12
                     'Itinerant CD4+ Naive T',#13
                     NA,
                     "Proliferating NK/T")#14

ntiss10x.immune.Tcells@meta.data[,'free_annotation'] <- NA
ntiss10x.immune.Tcells@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.immune.Tcells@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.immune.Tcells, group.by = "free_annotation")
```

# Subclustering normal immune cells (T cells, Round 2)

```{r, fig.width=10, fig.height=10}
cells.to.use <- WhichCells(ntiss10x.immune.Tcells, ident = c(2,3,4,5,12,14))
ntiss10x.immune.Tcells.r2 = SubsetData(ntiss10x.immune.Tcells, cells.use = cells.to.use)
```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.Tcells.r2 <- ntiss10x.immune.Tcells.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.immune.Tcells.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune.Tcells.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune.Tcells.r2, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

PCElbowPlot(ntiss10x.immune.Tcells.r2, num.pc = 30)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 7
normal.res.use = 2
ntiss10x.immune.Tcells.r2 <- ntiss10x.immune.Tcells.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/10) %>%
    RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=40)

TSNEPlot(object = ntiss10x.immune.Tcells.r2, do.label = T, pt.size = 1.2, label.size = 4)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.immune.Tcells.r2, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.immune.Tcells.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.immune.Tcells.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.immune.Tcells.r2, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.immune.Tcells.r2, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=70, fig.width=10}


genes_to_check = toupper(c('PTPRC', 'PECAM1', 'EPCAM', 'COL1A1', 'CD3E', 'CD4', 'CD8A', 'KLRB1','CHST2', 'MKI67', 'FCER1G', 'TYROBP', 'AREG', 'HOPX', 'LTB', 'COTL1', 'LDHB', 'CCR7', 'LEF1', 'GZMH', 'GZMB', 'IL7R', 'GZMK', 'DUSP2'))

FeaturePlot(ntiss10x.immune.Tcells.r2, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols, dark.theme = T, no.legend = T)


```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.Tcells.r2.markers <- FindAllMarkers(ntiss10x.immune.Tcells.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T, max.cells.per.ident = 200)

```


```{r, fig.height=90, fig.width=10}
genes_to_check <- ntiss10x.immune.Tcells.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.immune.Tcells.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.immune.Tcells.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# FCER1G+ TYROBP+ GZMB+ CHST2+ HOPX+ AREG- CD3E- -> Natural Killer Cell
# CD3E+ CD4+ LTB+ COTL1+ LDHB+ CCR7- LEF1- -> CD4+ Memory T Cell
# CD3E+ CD4+ LTB+ LDHB+ CCR7+ LEF1+ COTL1- -> CD4+ Naive T Cell
# CD3E+ CD8+ GZMH+ GZMB+ LTB- IL7R- GZMK- DUSP2- -> CD8+ Naive T Cell
# CD3E+ CD8+ GZMK+ KLRB1+ IL7R+ DUSP2+ GZMH- GZMB- -> CD8+ Memory T Cell


# stash current cluster IDs
ntiss10x.immune.Tcells.r2 <- StashIdent(object = ntiss10x.immune.Tcells.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.immune.Tcells.r2@ident)))
free_annotation <- c("Circulating CD8+ Naive T",#0
                     'Itinerant Natural Killer',#1
                     "Itinerant CD4+ Memory T",#2
                     "Itinerant CD8+ Naive T",#3
                     "Itinerant Natural Killer",#4
                     'Itinerant CD8+ Naive T',#5
                     "Itinerant CD8+ Naive T",#6
                     "Itinerant CD4+ Memory T",#7
                     NA,#8
                     "Itinerant CD8+ Memory T",#9
                     "Circulating CD8+ Memory T",#10
                     "Itinerant CD8+ Memory T",#11
                     NA,#12
                     "Circulating CD8+ Naive T",#13
                     "Circulating Natural Killer",#14
                     "Circulating CD8+ Naive T",#15
                     "Itinerant CD8+ Naive T")#16

ntiss10x.immune.Tcells.r2@meta.data[,'free_annotation'] <- NA
ntiss10x.immune.Tcells.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.immune.Tcells.r2@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.immune.Tcells.r2, group.by = "free_annotation")
```






# Subclustering normal immune cells (Denedritic cells/ nonobvious macrophages, Round 2)

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.r2 = SubsetData(ntiss10x.immune, ident.use = c(12,21,5,6,16))
```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.r2 <- ntiss10x.immune.r2 %>% ScaleData() %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 30) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.immune.r2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune.r2, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.immune.r2, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)

PCElbowPlot(ntiss10x.immune.r2, num.pc = 30)
```


```{r, fig.width=10, fig.height=10}
normal.n.pcs = 14
normal.res.use = 1
ntiss10x.immune.r2 <- ntiss10x.immune.r2 %>% FindClusters(reduction.type = "pca", dims.use = 1:normal.n.pcs,
    resolution = normal.res.use, print.output = 0, save.SNN = TRUE, force.recalc = TRUE, plot.SNN = TRUE, prune.SNN = 1/4.5) %>%
      RunTSNE(dims.use = 1:normal.n.pcs, seed.use = 10, perplexity=30)


TSNEPlot(ntiss10x.immune.r2, label.size = 4, pt.size = 1.2, do.label = T)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.immune.r2, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.immune.r2, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.immune.r2, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.immune.r2, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.immune.r2, do.return = TRUE, group.by = "compartment")
```

```{r, fig.height=60, fig.width=10}

genes_to_check = toupper(c('CD3E', 'CD8A', 'CD4', 'CD79A', 'GPR183', 'MRC1', 'MARCO', 'KLRB1',
                           'FCER1A','CD1C','PAK1',#MYELOID DENDRITIC CELL
                           'LGALS2','CD14','NRG1', #CLASSOCIAL MONOCYTE
                           'FCGR3A', 'LAMP3','TIMP3', 'IGSF21', 'NAMPT', 'TREM2'))

FeaturePlot(ntiss10x.immune.r2, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols,dark.theme = T)

```

```{r, fig.width=10, fig.height=10}
ntiss10x.immune.r2.markers <- FindAllMarkers(ntiss10x.immune.r2, min.pct = 0.25, thresh.use = 0.25, only.pos = T, max.cells.per.ident = 200)

```


```{r, fig.height=160, fig.width=10}
genes_to_check <- ntiss10x.immune.r2.markers %>% group_by(cluster) %>% top_n(-4, p_val_adj)
ntiss10x.immune.r2.markers %>% group_by(cluster) %>% top_n(-10, p_val_adj)
FeaturePlot(ntiss10x.immune.r2, genes_to_check$gene, pt.size = 1, nCol = 2, cols.use = my.cols)
```

## Assigning cell type identity to clusters


```{r, fig.width=10, fig.height=10}
# At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:
# CD3E+ CD8+ GZMH+ GZMB+ LTB- IL7R- GZMK- DUSP2- -> CD8+ Naive T Cell
# CD3E+ CD8+ GZMK+ KLRB1+ IL7R+ DUSP2+ GZMH- GZMB- -> CD8+ Memory T Cell
# FCER1A+ CD1C+ PAK1+ PKIB+ -> Myeloid Dendritic Cell
#                     "CD14+ CD16+ IGSF21+ Dendritic Cell (Lung)", #Throwing these out, look like NK/T/B but with much lower   expression
        #             "CD14+ CD16+ NAMPT+ Dendritic Cell (Lung)",
        #             "TIMP3+ Dendritic Cell (Lung)",
        #             "Plasmacytoid Dendritic",
        #             #5
        #             "CD79+ CD27+ Dendritic",
         #            "LAMP3+ Dendritic Cell (Lung)"


# stash current cluster IDs
ntiss10x.immune.r2 <- StashIdent(object = ntiss10x.immune.r2, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:max(as.numeric(levels(ntiss10x.immune.r2@ident)))
free_annotation <- c("Circulating Classical Monocyte",#0
                     "Circulating Classical Monocyte",#1
                     "Itinerant Classical Monocyte",#2
                     "Itinerant Classical Monocyte",#3
                     "Myeloid Dendritic Type 2",#4
                     NA,
                     "Itinerant Classical Monocyte",
                     "Macrophage",
                     "Itinerant Nonclassical Monocyte",
                     "Itinerant Nonclassical Monocyte",
                     NA,
                    'TREM2+ Dendritic',
                    "Macrophage",
                    "IGSF21+ Dendritic",
                    "Circulating Nonclassical Monocyte",
                    "Myeloid Dendritic Type 1",
                    "IGSF21+ Dendritic")

ntiss10x.immune.r2@meta.data[,'free_annotation'] <- NA
ntiss10x.immune.r2@meta.data[,'free_annotation'] <- as.character(plyr::mapvalues(x = ntiss10x.immune.r2@ident, from = cluster.ids, to = free_annotation))
TSNEPlot(ntiss10x.immune.r2, group.by = "free_annotation")
```



# Combine all the annotations into the main object

```{r, fig.width=10, fig.height=10}
ntiss10x@meta.data[,'free_annotation'] <- NA


ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi@meta.data)),'free_annotation'] <- ntiss10x.epi@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi.r2@meta.data)),'free_annotation'] <- ntiss10x.epi.r2@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi.r2@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi.r3@meta.data)),'free_annotation'] <- ntiss10x.epi.r3@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi.r3@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi.r4@meta.data)),'free_annotation'] <- ntiss10x.epi.r4@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.epi.r4@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.endo@meta.data)),'free_annotation'] <- ntiss10x.endo@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.endo@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.stromal@meta.data)),'free_annotation'] <- ntiss10x.stromal@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.stromal@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.stromal.r2@meta.data)),'free_annotation'] <- ntiss10x.stromal.r2@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.stromal.r2@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.stromal.r3@meta.data)),'free_annotation'] <- ntiss10x.stromal.r3@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.stromal.r3@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune@meta.data)),'free_annotation'] <- ntiss10x.immune@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune.Tcells@meta.data)),'free_annotation'] <- ntiss10x.immune.Tcells@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune.Tcells@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune.Tcells.r2@meta.data)),'free_annotation'] <- ntiss10x.immune.Tcells.r2@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune.Tcells.r2@meta.data)),'free_annotation']

ntiss10x@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune.r2@meta.data)),'free_annotation'] <- ntiss10x.immune.r2@meta.data[intersect(rownames(ntiss10x@meta.data[which(is.na(ntiss10x@meta.data[,'free_annotation'])),]),rownames(ntiss10x.immune.r2@meta.data)),'free_annotation']

```


```{r, fig.width=10, fig.height=10}
TSNEPlot(ntiss10x, do.label = T, group.by = 'free_annotation', no.legend = T)

```


```{r, fig.width=10, fig.height=10}
sort(table(ntiss10x@meta.data[,'free_annotation']), decreasing = T)
```

# Patient specific DE tests of circulating versus resident immune cells
```{r}
ntiss10x <- SetIdent(ntiss10x, cells.use = rownames(ntiss10x@meta.data[which(!is.na(ntiss10x@meta.data[,'free_annotation'])),]), ident.use =  ntiss10x@meta.data[which(!is.na(ntiss10x@meta.data[,'free_annotation'])),'free_annotation'])

CD4Naive.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating CD4+ Naive T', ident.2 = 'Itinerant CD4+ Naive T')
CD4Memory.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating CD4+ Memory T', ident.2 = 'Itinerant CD4+ Memory T')
CD8Naive.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating CD8+ Naive T', ident.2 = 'Itinerant CD8+ Naive T')
CD8Memory.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating CD8+ Memory T', ident.2 = 'Itinerant CD8+ Memory T')

NK.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating Natural Killer', ident.2 = 'Itinerant Natural Killer')

ClassMono.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating Classical Monocyte', ident.2 = 'Itinerant Classical Monocyte')
NonClassMono.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating Nonclassical Monocyte', ident.2 = 'Itinerant Nonclassical Monocyte')

BPlasma.markers <- FindMarkers(ntiss10x, ident.1 = 'B', ident.2 = 'Plasma')


ntiss10x <- SetIdent(ntiss10x, cells.use = rownames(ntiss10x@meta.data[intersect(which(ntiss10x@meta.data[,'free_annotation'] == 'Plasmacytoid Dendritic'), which(ntiss10x@meta.data[,'tissue'] == 'Blood')),]), ident.use = 'Circulating Plasmacytoid Dendritic')


ntiss10x <- SetIdent(ntiss10x, cells.use = rownames(ntiss10x@meta.data[intersect(which(ntiss10x@meta.data[,'free_annotation'] == 'Plasmacytoid Dendritic'), which(ntiss10x@meta.data[,'tissue'] == 'Lung')),]), ident.use = 'Itinerant Plasmacytoid Dendritic')

pDC.markers <- FindMarkers(ntiss10x, ident.1 = 'Circulating Plasmacytoid Dendritic', ident.2 = 'Itinerant Plasmacytoid Dendritic')

write.csv(CD4Naive.markers, file = "CD4Naive.markers.csv")
write.csv(CD4Memory.markers, file = "CD4Memory.markers.csv")
write.csv(CD8Naive.markers, file = "CD8Naive.markers.csv")
write.csv(CD8Memory.markers, file = "CD8Memory.markers.csv")
write.csv(NK.markers, file = "NK.markers.csv")

write.csv(ClassMono.markers, file = "ClassMono.markers.csv")
write.csv(NonClassMono.markers, file = "NonClassMono.markers.csv")

write.csv(BPlasma.markers, file = "BPlasma.markers.csv")

write.csv(pDC.markers, file = "pDC.markers.csv")


```


# Removing suspected doublets/cells with low UMIs

```{r, fig.width=10, fig.height=10}
ntiss10x.anno = SubsetData(ntiss10x, cells.use = rownames(ntiss10x@meta.data[which(!is.na(ntiss10x@meta.data[,'free_annotation'])),]))
```

```{r, fig.width=10, fig.height=10}
ntiss10x.anno <- ntiss10x.anno %>%
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE, pcs.compute = 40) %>% ProjectPCA(do.print = FALSE)
```

```{r, fig.width=10, fig.height=10}
PCHeatmap(object = ntiss10x.anno, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.anno, pc.use = 10:18, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.anno, pc.use = 19:27, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)
PCHeatmap(object = ntiss10x.anno, pc.use = 28:36, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 20, col.use = my.cols)


PCElbowPlot(ntiss10x.anno, num.pc = 40)
```


```{r, fig.width=10, fig.height=10}
n.pcs = 35
ntiss10x.anno <- ntiss10x.anno %>%
    RunTSNE(dims.use = 1:n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = ntiss10x.anno, do.label = T, pt.size = 1.2, label.size = 4, group.by = 'free_annotation', no.legend = TRUE)

```

```{r, fig.width=10, fig.height=10}
# Batch and sample effects
TSNEPlot(object = ntiss10x.anno, do.return = TRUE, group.by = "channel", no.legend = T)
TSNEPlot(object = ntiss10x.anno, do.return = TRUE, group.by = "region")
TSNEPlot(object = ntiss10x.anno, do.return = TRUE, group.by = "tissue")
TSNEPlot(object = ntiss10x.anno, do.return = TRUE, group.by = "area")
TSNEPlot(object = ntiss10x.anno, do.return = TRUE, group.by = "compartment")

```


```{r, fig.width=10, fig.height=10}

genes_to_check = toupper(c('Epcam', 'Pecam1', 'Ptprc', 'Col1a1'))

FeaturePlot(ntiss10x.anno, genes_to_check, pt.size = 1, nCol = 2, cols.use = my.cols)

```

## Reassign clusters based on cell type


```{r, fig.width=10, fig.height=10}

clusters = 1:length(table(ntiss10x.anno@meta.data[,'free_annotation']))
names(clusters) = names(sort(table(ntiss10x.anno@meta.data[,'free_annotation']), decreasing = T))
ntiss10x.anno@meta.data[,'cluster_ids'] <- clusters[ntiss10x.anno@meta.data[,'free_annotation']]
clusters <- clusters[ntiss10x.anno@meta.data[,'free_annotation']]
names(clusters) <- rownames(ntiss10x.anno@meta.data)
ntiss10x.anno@ident <- as.factor(clusters)


```


```{r, fig.width=10, fig.height=10}
TSNEPlot(object = ntiss10x.anno, do.label = T, pt.size = 1.2, label.size = 4, no.legend = TRUE)

```


# Save the Robject for later
When you save the annotated tissue, please give it a name.

```{r, fig.width=10, fig.height=10}
ntiss10x.P3.anno <- ntiss10x.anno
filename = paste0("seurat/droplet_normal_lung_blood_seurat_ntiss10x.P3.anno.20190129.RC2.Robj")
print(filename)
save(ntiss10x.P3.anno, file=filename)
```

```{r, fig.width=10, fig.height=10}
# To reload a saved object
# load(file=filename)
```

